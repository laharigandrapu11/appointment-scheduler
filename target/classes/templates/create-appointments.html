<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Create Appointments - Appointment Scheduler</title>
  </head>
  
  <body>
    <h1>Create Appointments</h1>
    
    <div>
      <a th:href="@{/}">Home Page</a> | 
      <a th:href="@{/logout}">Logout</a>
    </div>
    
    <form method="POST" th:action="@{/appointments}" th:object="${appointment}">
      <div>
        <label for="title">Title:</label>
        <input type="text" th:field="*{title}" id="title" required/>
        <span th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Title Error</span>
      </div>
      
      <div>
        <label for="description">Description:</label>
        <textarea th:field="*{description}" id="description" rows="3" required></textarea>
        <span th:if="${#fields.hasErrors('description')}" th:errors="*{description}">Description Error</span>
      </div>
      
      <div>
        <label for="location">Location:</label>
        <input type="text" th:field="*{location}" id="location" required/>
        <span th:if="${#fields.hasErrors('location')}" th:errors="*{location}">Location Error</span>
      </div>
      
      <div>
        <label for="appointmentType">Appointment Type:</label>
        <select th:field="*{appointmentType}" id="appointmentType" required>
          <option value="">Select type</option>
          <option value="Group">Group</option>
          <option value="Individual">Individual</option>
        </select>
        <span th:if="${#fields.hasErrors('appointmentType')}" th:errors="*{appointmentType}">Type Error</span>
      </div>
      
      <div>
        <label for="durationMinutes">Duration per Appointment (minutes):</label>
        <input type="number" th:field="*{durationMinutes}" id="durationMinutes" min="1" required/>
        <span th:if="${#fields.hasErrors('durationMinutes')}" th:errors="*{durationMinutes}">Duration Error</span>
      </div>
      
      <div>
        <label for="gapMinutes">Gap Between Appointments (minutes):</label>
        <input type="number" th:field="*{gapMinutes}" id="gapMinutes" min="0" value="0" required/>
        <span th:if="${#fields.hasErrors('gapMinutes')}" th:errors="*{gapMinutes}">Gap Error</span>
      </div>
      
      <hr/>
      
      <h3>Appointment Schedule</h3>
      
      <div id="daySchedulesContainer">
        <!-- Dynamic Day Schedules will be added here -->
      </div>
      
      <button type="button" onclick="addDay()">+ Add Another Day</button>
      
      <br/><br/>
      <div>
        <button type="submit">Create Appointments</button>
        <a th:href="@{/}">Cancel</a>
      </div>
    </form>

    <script>
          let dayCount = 0;
          
          function addDay() {
            const container = document.getElementById('daySchedulesContainer');
            
            const fieldset = document.createElement('fieldset');
            fieldset.id = 'day-' + dayCount;
            
            if (dayCount === 0) {
              fieldset.innerHTML = `
                <legend>Day 1 (Required)</legend>
                <div>
                  <label for="date">Date:</label>
                  <input type="date" name="date" id="date" required/>
                </div>
                <div>
                  <label for="startTime">Start Time:</label>
                  <input type="time" name="startTime" id="startTime" required/>
                </div>
                <div>
                  <label for="endTime">End Time:</label>
                  <input type="time" name="endTime" id="endTime" required/>
                </div>
              `;
            } else {
              const index = dayCount - 1;
              fieldset.innerHTML = `
                <legend>Day ${dayCount + 1} (Optional)</legend>
                <button type="button" onclick="removeDay(${dayCount})" style="float:right;">Remove</button>
                <div>
                  <label for="daySchedule${index}.date">Date:</label>
                  <input type="date" name="daySchedule[${index}].date" id="daySchedule${index}.date"/>
                </div>
                <div>
                  <label for="daySchedule${index}.startTime">Start Time:</label>
                  <input type="time" name="daySchedule[${index}].startTime" id="daySchedule${index}.startTime"/>
                </div>
                <div>
                  <label for="daySchedule${index}.endTime">End Time:</label>
                  <input type="time" name="daySchedule[${index}].endTime" id="daySchedule${index}.endTime"/>
                </div>
              `;
            }
            
            container.appendChild(fieldset);
            
            const br = document.createElement('br');
            br.id = 'br-' + dayCount;
            container.appendChild(br);
            
            dayCount++;
          }
          
          function removeDay(id) {
            if (id === 0) {
              alert('Cannot remove the first day. It is required.');
              return;
            }
            
            const fieldset = document.getElementById('day-' + id);
            const br = document.getElementById('br-' + id);
            
            if (fieldset) {
              fieldset.remove();
            }
            if (br) {
              br.remove();
            }
            
            renumberDays();
          }
          
          function renumberDays() {
            const container = document.getElementById('daySchedulesContainer');
            const fieldsets = container.querySelectorAll('fieldset');
            
            const daysData = [];
            
            for (let i = 0; i < fieldsets.length; i++) {
              const fieldset = fieldsets[i];
              const dateInput = fieldset.querySelector('input[type="date"]');
              const timeInputs = fieldset.querySelectorAll('input[type="time"]');
              
              daysData.push({
                date: dateInput ? dateInput.value : '',
                startTime: timeInputs[0] ? timeInputs[0].value : '',
                endTime: timeInputs[1] ? timeInputs[1].value : ''
              });
            }
            
            container.innerHTML = '';
            dayCount = 0;
            
            for (let i = 0; i < daysData.length; i++) {
              const data = daysData[i];
              const fieldset = document.createElement('fieldset');
              fieldset.id = 'day-' + dayCount;
              
              if (i === 0) {
                fieldset.innerHTML = `
                  <legend>Day 1 (Required)</legend>
                  <div>
                    <label for="date">Date:</label>
                    <input type="date" name="date" id="date" value="${data.date}" required/>
                  </div>
                  <div>
                    <label for="startTime">Start Time:</label>
                    <input type="time" name="startTime" id="startTime" value="${data.startTime}" required/>
                  </div>
                  <div>
                    <label for="endTime">End Time:</label>
                    <input type="time" name="endTime" id="endTime" value="${data.endTime}" required/>
                  </div>
                `;
              } else {
                const index = i - 1;
                fieldset.innerHTML = `
                  <legend>Day ${i + 1} (Optional)</legend>
                  <button type="button" onclick="removeDay(${dayCount})" style="float:right;">Remove</button>
                  <div>
                    <label for="daySchedule${index}.date">Date:</label>
                    <input type="date" name="daySchedule[${index}].date" id="daySchedule${index}.date" value="${data.date}"/>
                  </div>
                  <div>
                    <label for="daySchedule${index}.startTime">Start Time:</label>
                    <input type="time" name="daySchedule[${index}].startTime" id="daySchedule${index}.startTime" value="${data.startTime}"/>
                  </div>
                  <div>
                    <label for="daySchedule${index}.endTime">End Time:</label>
                    <input type="time" name="daySchedule[${index}.endTime" id="daySchedule${index}.endTime" value="${data.endTime}"/>
                  </div>
                `;
              }
              
              container.appendChild(fieldset);
              
              const br = document.createElement('br');
              br.id = 'br-' + dayCount;
              container.appendChild(br);
              
              dayCount++;
            }
          }
          
          window.addEventListener('DOMContentLoaded', function() {
            addDay();
          });
    </script>
  </body>
</html>
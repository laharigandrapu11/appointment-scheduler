<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Login - Appointment Booking System</title>
  </head>
  
  <body>
    <h1>Login</h1>

    <div th:if="${error}" 
         th:text="${error}">
    </div>

    <form id="loginForm" onsubmit="handleLogin(event)">
      <div>
        <label for="email">Email: </label>
        <input type="email" id="email" name="email" required/>
      </div>
      <br/>
      
      <div>
        <label for="password">Password: </label>
        <input type="password" id="password" name="password" required/>
      </div>
      <br/>

      <div id="errorMessage" style="color: red;"></div>
      <br/>

      <input type="submit" value="Login"/>
    </form>

    <div>
      <p>No account? <a th:href="@{/register}">Register here</a></p>
    </div>

    <script>
      async function handleLogin(event) {
          event.preventDefault();
          const errorDiv = document.getElementById('errorMessage');
          
          const formData = {
              email: document.getElementById('email').value,
              password: document.getElementById('password').value
          };

          try {
              const response = await fetch('/users/login', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(formData)
              });

              if (response.ok) {
                  const result = await response.json();
                  window.location.href = '/'; 
              } else {
                  const error = await response.json();
                  errorDiv.textContent = error.message || 'Login failed, Please try again.';
              }
          } catch (error) {
              errorDiv.textContent = 'Error occurred, Please try again.';
          }
      }
    </script>
  </body>
</html>
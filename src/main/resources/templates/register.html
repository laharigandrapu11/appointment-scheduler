<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Register - Appointment Booking System</title>
  </head>
  
  <body>
    <h1>Register New Account</h1>

    <div th:if="${error}" 
         th:text="${error}">
    </div>

    <form id="registerForm" onsubmit="handleRegister(event)">
      <div>
        <label for="name">Full Name: </label>
        <input type="text" id="name" name="name" required/>
      </div>
      <br/>

      <div>
        <label for="email">Email: </label>
        <input type="email" id="email" name="email" required/>
      </div>
      <br/>
      
      <div>
        <label for="password">Password: </label>
        <input type="password" id="password" name="password" required minlength="6"/>
      </div>
      <br/>

      <div>
        <label for="role">Role: </label>
        <select id="role" name="role" required>
          <option value="">Select a role</option>
          <option value="STUDENT">Student</option>
          <option value="PROFESSOR">Professor</option>
          <option value="TA">Teaching Assistant</option>
        </select>
      </div>
      <br/>

      <div id="errorMessage" style="color: red;"></div>
      <br/>

      <input type="submit" value="Register"/>
    </form>

    <div>
      <p>Already have an account? <a th:href="@{/login}">Login here</a></p>
    </div>

    <script>
      async function handleRegister(event) {
          event.preventDefault();
          const errorDiv = document.getElementById('errorMessage');
          
          const formData = {
              username: document.getElementById('name').value,
              email: document.getElementById('email').value,
              password: document.getElementById('password').value,
              role: document.getElementById('role').value
          };

          try {
              const response = await fetch('/users/register', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(formData)
              });

              if (response.ok) {
                  const result = await response.json();
                  window.location.href = '/login';  // Redirect to login page after successful registration
              } else {
                  const error = await response.json();
                  errorDiv.textContent = error.message || 'Registration failed. Please try again.';
              }
          } catch (error) {
              errorDiv.textContent = 'An error occurred. Please try again.';
          }
      }
    </script>
  </body>
</html>